<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<!-- Load color palettes -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>
// Set the dimensions and margins of the graph
var margin = {top: 80, right: 50, bottom: 120, left: 180};

// Function to draw the heatmap
function drawHeatmap(data) {
  // Clear existing content
  var svgContainer = d3.select("#my_dataviz").html("");

  // Get the dimensions of the container
  var containerWidth = svgContainer.node().getBoundingClientRect().width;
  var containerHeight = containerWidth * 0.75; // Assuming a 4:3 aspect ratio

  // Calculate the width and height of the SVG
  var width = containerWidth - margin.left - margin.right;
  var height = containerHeight - margin.top - margin.bottom;

  // Append the svg object to the container
  var svg = svgContainer.append("svg")
    .attr("width", containerWidth)
    .attr("height", containerHeight)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Labels of row and columns
  var myRows = Array.from(new Set(data.map(d => d.row)));
  var myCols = Array.from(new Set(data.map(d => d.col)));

  // Build X scales and axis
  var x = d3.scaleBand()
    .range([0, width])
    .domain(myCols)
    .padding(0.05);

  var xAxis = svg.append("g")
    .style("font-size", 15)
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0));

  xAxis.selectAll("text")
    .attr("class", "colLabel")
    .style("text-anchor", "end") // Set text anchor to end so that text rotates around its end
    .attr("dx", "-.8em") // Adjust text position
    .attr("dy", ".15em") // Adjust text position
    .attr("transform", "rotate(-45)"); // Rotate text by -45 degrees

  // Build Y scales and axis
  var y = d3.scaleBand()
    .range([height, 0])
    .domain(myRows)
    .padding(0.05);

  var yAxis = svg.append("g")
    .style("font-size", 15)
    .call(d3.axisLeft(y).tickSize(0));

  yAxis.selectAll("text")
    .attr("class", "rowLabel");

  // Build color scale
  var myColor = d3.scaleSequential()
    .interpolator(d3.interpolateInferno)
    .domain([1, 0]); // Inverted domain

  // Create a tooltip
  var tooltip = d3.select("#my_dataviz")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px");

  // Tooltip functions
  var mouseover = function(d) {
    tooltip
      .style("opacity", 1);
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1);
    // Highlight row and column labels
    svg.selectAll(".rowLabel").filter(function(row) { return row === d.row; }).style("font-weight", "bold").style("fill", "red");
    svg.selectAll(".colLabel").filter(function(col) { return col === d.col; }).style("font-weight", "bold").style("fill", "red");
    // Highlight corresponding cells
    svg.selectAll("rect").filter(function(cell) { return cell.row === d.row || cell.col === d.col; })
      .style("stroke", "black").style("stroke-width", 2);
  };
  var mousemove = function(d) {
    tooltip
      .html("r/" + d.row + " has User Overlap of " + d.value + " with " + "r/" + d.col)
      .style("left", (d3.event.pageX + 70) + "px")
      .style("top", (d3.event.pageY) + "px");
  };
  var mouseleave = function(d) {
    tooltip
      .style("opacity", 0);
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8);
    // Remove highlight from row and column labels
    svg.selectAll(".rowLabel").style("font-weight", "normal").style("fill", "black");
    svg.selectAll(".colLabel").style("font-weight", "normal").style("fill", "black");
    // Remove highlight from corresponding cells
    svg.selectAll("rect").style("stroke", "none");
  };

  // Add the squares
  svg.selectAll()
    .data(data, function(d) { return d.row + ':' + d.col; })
    .enter()
    .append("rect")
    .attr("x", function(d) { return x(d.col); })
    .attr("y", function(d) { return y(d.row); })
    .attr("rx", 4)
    .attr("ry", 4)
    .attr("width", x.bandwidth())
    .attr("height", y.bandwidth())
    .style("fill", function(d) { return myColor(d.value); })
    .style("stroke-width", 4)
    .style("stroke", "none")
    .style("opacity", 0.8)
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave);

  // Add title to graph
  svg.append("text")
    .attr("x", 0)
    .attr("y", -50)
    .attr("text-anchor", "left")
    .style("font-size", "22px")
    .text("User Overlap");

  // Add subtitle to graph
  svg.append("text")
    .attr("x", 0)
    .attr("y", -20)
    .attr("text-anchor", "left")
    .style("font-size", "14px")
    .style("fill", "grey")
    .style("max-width", 400)
    .text("User Overlap of Mental Health Communities on Reddit depending on unique authors (community size).");
}

// Load the data
d3.json("../data/HeatmapData.json", function(data) {
  // Convert the data to an array format expected by D3
  const dataArray = Object.values(data);
  drawHeatmap(dataArray);

  // Resize event listener
  window.addEventListener('resize', function() {
    drawHeatmap(dataArray); // Redraw the heatmap on window resize
  });
});

</script>
