<!doctype html>
<html lang="en" style="min-width:100vh;min-height:100vh">
<head >
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Top navbar example · Bootstrap v5.0</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbar-static/">


    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- Favicons -->
    <meta name="theme-color" content="#7952b3">


    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
    </style>


    <!-- Custom styles for this template -->
    <link href="css/navbar.css" rel="stylesheet">
</head>
<body class="vh-100" style="overflow:hidden">
<h1 class="bg-dark text-white mb-0 mx-auto p-4">Mental Health Subreddits</h1>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-3">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="index.html">Community Network</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ipynb/heatmap_test.html">User Overlap Heatmap</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ipynb/heatmap_content_similarity.html">Content Similarity Heatmap</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="d-flex flex-column" style="min-width:90vh;min-height:90vh">
    <div class="d-flex flex-nowrap justify-content-around" style="min-width:100vh;min-height:100vh">
        <div class="p-3 text-bg-dark d-inline-flex col-2">
            <div id="subreddits" style="display:block">
                <h4 style="padding:20px">Subreddit Info</h4>
                <ul id="listOfSubreddits">

                </ul>
            </div>
            <button type="button" id="collaps-subreddits"> ⇤ </button>
        </div>
        <div id="visualisationArea" class="bg-light col p-5" >
            <svg id="myPlot" width="100%" height="100%"></svg>
        </div>
        <div class=" p-3 text-bg-dark col-2 d-inline-flex col-2">
            <button type="button" id="collaps-filters"> ⇥ </button>
            <div id="filters" style="display:block; padding:10px">
                <h4>Sentiment</h4>
                <h6>Negative - Positive</h6>
                <svg id="key"></svg>
                <h4 style="padding:20px">Filters</h4>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckSentiment" checked>
                    <label class="form-check-label" for="flexSwitchCheckSentiment">Show Sentiment</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckCommunitySize" checked>
                    <label class="form-check-label" for="flexSwitchCheckCommunitySize">Show Community Size</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckText" checked>
                    <label class="form-check-label" for="flexSwitchCheckText">Show Values at click</label>
                </div>
                </div>

        </div>
    </div>

    <div class="text-bg-dark fixed-bottom">
        Visual Analytics Groupe 20: Thomas Aumüller, Katharina Bein, Konstantin Windisch
    </div>
</main>


<script type="text/javascript" src="js/bootstrap.bundle.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<!--<script type="module" src="js/papaparse.js"></script>-->
<script type="text/javascript" src="js/jquery.csv.js"></script>
<script type="text/javascript" src="js/d3.v7.js"></script>

<script>

    var flexSwitchCheckSentiment = true;

    $('#flexSwitchCheckSentiment').click(function(e) {
        flexSwitchCheckSentiment = $(this).is(":checked");
    });

    // Specify the color scale.
    var color = d3.scaleSequential()
        .interpolator(d3.interpolateHclLong("purple", "orange"))
        .domain([-1, 1]);

    d3.json("/data/NetworkGraphData.json").then(function (data) {

        // Specify the dimensions of the chart.
        const width = $('#myPlot').width();
        const height = $('#myPlot').height();

        // The force simulation mutates links and nodes, so create a copy
        // so that re-evaluating this cell produces the same result.
        const links = data.links.map(d => ({...d}));
        const nodes = data.nodes.map(d => ({...d}));
        

        // Create a simulation with several forces.
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2.5))
            .on("tick", ticked);

        // Create the SVG container.
        const svg = d3.select("#myPlot")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            // .attr("viewBox", [0, 0, width, height])
            // .attr("style", "max-width: 100%; height: auto;");


        // Add a line for each link, and a circle for each node.
        const link = svg.append("g")
            .attr("stroke", "black")
            .attr("stroke-opacity", 0.6)
            .selectAll()
            .data(links)
            .join("path")
            .attr("stroke-width", d => Math.sqrt(d.value))
            .attr('fill', 'none');

        // Add arrows to paths
        svg.append('defs').selectAll('marker')
            .data(['suit', 'licensing', 'resolved'])
            .enter().append('marker')
            .attr('id', 'arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5');

        // Add nodes with size and sentiment color
        const node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll()
            .data(nodes)
            .join("circle")
            .attr("r", function(d) { return d.size * 0.001 + 3; })
            .attr("fill", function(d) { return color(d.sentiment_compound); });

        // Add Color Sentiment switch logic
        $('#flexSwitchCheckSentiment').click(function(e) {
            var flexSwitchCheckSentiment = $(this).is(":checked");
            console.log(flexSwitchCheckSentiment);
            var bool = flexSwitchCheckSentiment ? function(d) { return color(d.sentiment_compound); } : "black";
            svg.selectAll("circle")
                .transition()
                .duration(200)
                .style("fill", bool);

        });

        // Add Size switch logic
        $('#flexSwitchCheckCommunitySize').click(function(e) {
            var flexSwitchCheckCommunitySize = $(this).is(":checked");
            var bool = flexSwitchCheckCommunitySize ? function(d) { return d.size * 0.001 + 3; } : 5;
            svg.selectAll("circle")
                .transition()
                .duration(200)
                .attr("r", bool);
        })

        // Add taxt to paths
        const text = svg.append("g")
            .attr("x", 6)
            .attr("dy", 15)
            .attr("pointer-events", "none")
            .style('font-size', 10)
            .selectAll()
            .data(links)
            .join("text")



        text.append("textPath")
            .attr("xlink:href",d => "#" + d.source.id + d.target.id)
            .attr('text-anchor', 'middle')
            .attr('startOffset', "50%")
            .attr("opacity", 1)
            .text(d => String(d.value.toFixed(2)));

        // Add Text Display switch logic
        var flexSwitchCheckText = true;
        $('#flexSwitchCheckText').click(function(e) {
            flexSwitchCheckText = $(this).is(":checked");
            var bool = flexSwitchCheckText ? 1 : 0;
            text.selectAll("textPath")
                .transition()
                .duration(200)
                .attr("opacity", bool);
        });

        node.append("title")
            .text(d => d.id);

        // Add a drag behavior.
        node.call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));



        // Makes the links curved
        function linkArc(d) {
            var dx = d.target.x - d.source.x,
                dy = d.target.y - d.source.y,
                dr = Math.sqrt(dx * dx + dy * dy);
            return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
        }

        // // Set the position attributes of links and nodes each time the simulation ticks.
        function ticked() {
            link
                .attr('d', d => linkArc(d));
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
        }

        // Reheat the simulation when drag starts, and fix the subject position.
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        // Update the subject (dragged node) position during drag.
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        // Restore the target alpha so the simulation cools after dragging ends.
        // Unfix the subject position now that it’s no longer being dragged.
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        const selectedNodeText = svg.append("text")
            .attr("x", 10)
            .attr("y", 20)
            .attr("font-size", "14px")
            .attr("fill", "black")
            .text("");

        // Function calls to zoom logic
        function handleZoom(e){
            d3.selectAll("circle")
                .attr("transform", e.transform);

            d3.selectAll("path")
                .attr("transform", e.transform);
        }


        let zoom = d3.zoom()
            .on("zoom", handleZoom)


        d3.select("svg").call(zoom)



        // Define a function to handle node click events
        function handleNodeClick(event, node, svg) {

            // Retrieve the selected node's ID
            const selectedNodeId = node.id;

            // Filter links to find connected links
            const connectedLinks = links.filter((link) => link.source.id === selectedNodeId || link.target.id === selectedNodeId);

            // Function call to get uniqu indices
            function onlyUnique(value, index, array) {
                return array.indexOf(value) === index;
            }

            //Add information to index screen
            $("#listOfSubreddits").html("<h4>" + selectedNodeId + "</h4>" +
                "<div><b>Sentiment:</b> " + node.sentiment + " (" + node.sentiment_compound + ")</div>" +
                "<a href='" + node.link  + "'>" + node.link+ "</a>" +
                "<div><b>Community Size: </b> " + node.size + "</div>" +
                "<div><b><u>Top 5 overlapping Communities: </u></b> " +
                connectedLinks
                .map((obj) =>
                    ["<li id='" + obj.target.id + "'><a class='nav-link' target='_blank' href='" + obj.target.link + "'>" + obj.target.id + "</a></li>",
                        "<li id='" + obj.source.id + "'><a class='nav-link' target='_blank' href='" + obj.source.link + "'>" + obj.source.id + "</a></li>"])
                .join().split(",").filter(onlyUnique)
                    .filter((x) => x !== "<li id='" + node.id + "'><a class='nav-link' target='_blank' href='" + node.link + "'>" + node.id + "</a></li>")
                    .join(""));

            // Highlight connected links
            svg.selectAll("path")
                .attr("stroke-opacity", d => connectedLinks.includes(d) ? 1 : 0.2)
                .attr("stroke-width", d => connectedLinks.includes(d) ? 1 : Math.sqrt(d.value))
                .attr('marker-end', d => connectedLinks.includes(d) ? "url(#arrow)" : null)
                .attr('id', d => connectedLinks.includes(d) ? d.source.id + d.target.id : null);

            // Highlight connected nodes (source and target)
            // svg.selectAll("circle")
            //     .attr("fill-opacity", d => d.id === selectedNodeId ? 1 : connectedLinks.some(link => link.source.id === d.id || link.target.id === d.id) ? 1 : 0.2)
            //     .attr("fill", d => d.id === selectedNodeId ? "red" : "black")
            //     .attr("r", d => d.id === selectedNodeId ? 6 : connectedLinks.some(link => link.source.id === d.id || link.target.id === d.id) ? 6 : 5);
        }

        // Add event listeners to nodes
        svg.selectAll("circle")
            .on("click", (event, d) => handleNodeClick(event, d, svg));

        //Add color bar to filter panel
        var colorBarSvg = d3.select("#key")
            .attr("width",100)
            .attr("height",20);

        var grad = colorBarSvg.append('defs')
            .append('linearGradient')
            .attr('id', 'grad')
            .attr('x1', '0%')
            .attr('x2', '100%')
            .attr('y1', '0%')
            .attr('y2', '0%');

        var colorGrad = [color(nodes.hasMin("sentiment_compound").sentiment_compound), color(nodes.hasMax("sentiment_compound").sentiment_compound)];
        grad.selectAll('stop')
            .data(colorGrad)
            .enter()
            .append('stop')
            .style('stop-color', function(d){ return d; })
            .attr('offset', function(d,i){
                return 100 * (i / (colorGrad.length - 1)) + '%';
            })

        colorBarSvg.append('rect')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', 100)
            .attr('height', 20)
            .style('fill', 'url(#grad)');

    });

    // Function call for min
    Array.prototype.hasMin = function(attrib) {
        return (this.length && this.reduce(function(prev, curr){
            return prev[attrib] < curr[attrib] ? prev : curr;
        })) || null;
    }

    // Function call for max
    Array.prototype.hasMax = function(attrib) {
        return (this.length && this.reduce(function(prev, curr){
            return prev[attrib] > curr[attrib] ? prev : curr;
        })) || null;
    }

    // Function call for collaping the filter and info panel
    function collapsPanels(idOfButton, idOfPanel) {
        $(idOfButton).click(function () {
            this.classList.toggle("active");

            var content = $(idOfPanel)[0];
            console.log(content);
            var parent = $(idOfPanel).parent();
            console.log(parent)
            if (content.style.display === "block") {
                content.style.display = "none";
                parent.removeClass("col-2");
                if(idOfButton === '#collaps-subreddits') {
                    $(idOfButton).html('⇥');
                }
                else if(idOfButton === '#collaps-filters') {
                    $(idOfButton).html('⇤');
                }
            } else {
                content.style.display = "block";
                parent.addClass("col-2");
                if(idOfButton === '#collaps-subreddits') {
                    $(idOfButton).html('⇤');
                }
                else if(idOfButton === '#collaps-filters') {
                    $(idOfButton).html('⇥');
                }
            }
        });
    }

    collapsPanels("#collaps-subreddits", "#subreddits");
    collapsPanels("#collaps-filters", "#filters");

</script>


</body>
</html>
